set(CMAKE_CXX_STANDARD 17)

file(GLOB CORE_SRC                  "include/core/*.h"                       "core/*.cpp")
file(GLOB EDITOR_SRC                "include/editor/*.h"                     "editor/*.cpp")
file(GLOB EDITOR_CLI_SRC            "include/editor/cli/*.h"                 "editor/cli/*.cpp")
file(GLOB MODEL_COMPONENTS_SRC      "include/model/components/*.h"           "model/components/*.cpp")
file(GLOB MODEL_RENDERING_SRC       "include/model/rendering/*.h"            "model/rendering/*.cpp")
file(GLOB MODEL_SRC                 "include/model/*.h"                      "model/*.cpp")
file(GLOB MODEL_CACHES_SRC          "include/model/caches/*.h"               "model/caches/*.cpp")
file(GLOB REFLECTION_SRC            "include/reflection/*.h"                 "reflection/*.cpp")
file(GLOB REFLECTION_HANDLERS_SRC   "include/reflection/type_handlers/*.h"   "reflection/type_handlers/*.cpp")
file(GLOB SERIALIZATION_SRC         "include/serialization/*.h"              "serialization/*.cpp")
file(GLOB UTILS_SRC                 "include/utils/*.h"                      "utils/*.cpp")
file(GLOB UI_SRC                    "include/ui/*.h"                         "ui/*.cpp")
file(GLOB VULKAN_RENDER_SRC         "include/vulkan_render/*.h"              "vulkan_render/*.cpp")
file(GLOB VULKAN_RENDER_LOADERS_SRC "include/vulkan_render/data_loaders/*.h" "vulkan_render/data_loaders/*.cpp")


source_group("core"                       FILES ${CORE_SRC})
source_group("editor"                     FILES ${EDITOR_SRC})
source_group("editor/cli"                 FILES ${EDITOR_CLI_SRC})
source_group("model"                      FILES ${MODEL_SRC})
source_group("model/caches"               FILES ${MODEL_CACHES_SRC})
source_group("model/components"           FILES ${MODEL_COMPONENTS_SRC})
source_group("model/rendering"            FILES ${MODEL_RENDERING_SRC})
source_group("reflection"                 FILES ${REFLECTION_SRC})
source_group("reflection/type_handlers"   FILES ${REFLECTION_HANDLERS_SRC})
source_group("serialization"              FILES ${SERIALIZATION_SRC})
source_group("vulkan_render"              FILES ${VULKAN_RENDER_SRC})
source_group("ui"                         FILES ${UI_SRC})
source_group("utils"                      FILES ${UTILS_SRC})
source_group("vulkan_render/data_loaders" FILES ${VULKAN_RENDER_LOADERS_SRC})


add_custom_target(generate.soal ALL)

set_target_properties(generate.soal PROPERTIES
    FOLDER "agea")

add_custom_command(
    TARGET generate.soal
    PRE_BUILD
    COMMAND python ${PROJECT_SOURCE_DIR}/tools/soal_gen.py
                   ${PROJECT_SOURCE_DIR}/engine/soal/config 
                   ${PROJECT_SOURCE_DIR}/engine 
                   ${CMAKE_BINARY_DIR}/agea_generated/soal.generated.cpp)

add_library(agea STATIC

    ${CORE_SRC}
    ${EDITOR_SRC}
    ${EDITOR_CLI_SRC}
    ${MODEL_SRC}
    ${MODEL_CACHES_SRC}
    ${MODEL_COMPONENTS_SRC}
    ${MODEL_RENDERING_SRC}
    ${REFLECTION_SRC}
    ${REFLECTION_HANDLERS_SRC}
    ${SERIALIZATION_SRC}
    ${VULKAN_RENDER_SRC}
    ${VULKAN_RENDER_LOADERS_SRC}
    ${UTILS_SRC}
    ${UI_SRC}

    ${CMAKE_BINARY_DIR}/agea_generated/soal.generated.cpp
 )

add_dependencies(agea generate.soal)
target_include_directories(agea PUBLIC "${CMAKE_CURRENT_SOURCE_DIR}/include" PUBLIC "${CMAKE_CURRENT_SOURCE_DIR}")

set_target_properties(agea PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY_DEBUG          "${CMAKE_BINARY_DIR}/project_Debug/bin"
    RUNTIME_OUTPUT_DIRECTORY_RELEASE        "${CMAKE_BINARY_DIR}/project_Release/bin"
    RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO "${CMAKE_BINARY_DIR}/project_RelWithDebInfo/bin"
    RUNTIME_OUTPUT_DIRECTORY_MINSIZEREL     "${CMAKE_BINARY_DIR}/project_MinSizeRel/bin"

    VS_DEBUGGER_WORKING_DIRECTORY "${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/bin"

    FOLDER "agea"
)

file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE})

if(EXISTS ${CMAKE_BINARY_DIR}/agea_generated/soal.generated.cpp)
    message("File already exists, skipping")
else()
    write_file(${CMAKE_BINARY_DIR}/agea_generated/soal.generated.cpp "// autogenerated sol file")
endif()

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/assets
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/assets)

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/shaders
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/shaders)

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/configs
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/configs)

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/fonts
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/fonts)

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/levels
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/levels)

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/objects
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/objects)

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/components
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/components)

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/components
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/components)

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/packages
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/packages)

execute_process(COMMAND ${CMAKE_COMMAND} -E create_symlink
    ${PROJECT_SOURCE_DIR}/resources/test
    ${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/test)

target_link_libraries(agea PUBLIC
    glm_unofficial
    imgui_unofficial
    jsoncpp_static   
    sdl2
    spirv-reflect-static
    spdlog::spdlog
    stb_unofficial
    tinyobjloader
    vma_unofficial
    vk-bootstrap::vk-bootstrap
    Vulkan::Vulkan
    yaml-cpp::yaml-cpp
)

add_executable(agea_editor "app/main.cpp")

set_target_properties(agea_editor PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY_DEBUG          "${CMAKE_BINARY_DIR}/project_Debug/bin"
    RUNTIME_OUTPUT_DIRECTORY_RELEASE        "${CMAKE_BINARY_DIR}/project_Release/bin"
    RUNTIME_OUTPUT_DIRECTORY_RELWITHDEBINFO "${CMAKE_BINARY_DIR}/project_RelWithDebInfo/bin"
    RUNTIME_OUTPUT_DIRECTORY_MINSIZEREL     "${CMAKE_BINARY_DIR}/project_MinSizeRel/bin"

    VS_DEBUGGER_WORKING_DIRECTORY "${CMAKE_BINARY_DIR}/project_${CMAKE_BUILD_TYPE}/bin"

    FOLDER "agea"
)

target_link_libraries(agea_editor agea) 